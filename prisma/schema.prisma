generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String             @id @default(cuid())
  email             String             @unique
  name              String?
  passwordHash      String
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  expenses          Expense[]
  categories        Category[]
  plaidItems        PlaidItem[]
  recurringExpenses RecurringExpense[]
}

model Category {
  id                String             @id @default(cuid())
  name              String
  color             String             @default("#6B7280")
  scheduleCCode     String?            // IRS Schedule C line reference
  userId            String
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  expenses          Expense[]
  recurringExpenses RecurringExpense[]
  createdAt         DateTime           @default(now())

  @@unique([name, userId])
}

model Expense {
  id                 String            @id @default(cuid())
  date               DateTime
  vendor             String
  description        String?
  amount             Decimal           @db.Decimal(10, 2)
  categoryId         String?
  category           Category?         @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  paymentMethod      String?
  notes              String?
  receiptPath        String?
  receiptName        String?
  tags               String?           // comma-separated tags
  plaidTransactionId String?           @unique // Plaid transaction ID to prevent duplicates
  recurringExpenseId String?
  recurringExpense   RecurringExpense? @relation(fields: [recurringExpenseId], references: [id], onDelete: SetNull)
  userId             String
  user               User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt

  @@index([userId, date])
  @@index([userId, categoryId])
  @@index([recurringExpenseId])
}

model RecurringExpense {
  id            String    @id @default(cuid())
  vendor        String
  description   String?
  amount        Decimal   @db.Decimal(10, 2)
  categoryId    String?
  category      Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  paymentMethod String?
  notes         String?
  tags          String?
  frequency     String    @default("monthly") // monthly, weekly, yearly
  dayOfMonth    Int       @default(1)          // 1-28 for monthly
  startDate     DateTime                       // when the recurring expense starts
  endDate       DateTime?                      // optional end date
  nextDueDate   DateTime                       // next date an expense should be generated
  isActive      Boolean   @default(true)
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  expenses      Expense[]                      // generated expenses
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([userId])
  @@index([isActive, nextDueDate])
}

model PlaidItem {
  id              String   @id @default(cuid())
  plaidItemId     String   @unique   // Plaid's item_id
  accessToken     String              // Encrypted access token
  institutionId   String?
  institutionName String?
  cursor          String?             // Transaction sync cursor
  lastSynced      DateTime?
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  accounts        PlaidAccount[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
}

model PlaidAccount {
  id             String    @id @default(cuid())
  plaidAccountId String    @unique  // Plaid's account_id
  name           String
  officialName   String?
  type           String              // e.g. "credit", "depository"
  subtype        String?             // e.g. "credit card", "checking"
  mask           String?             // Last 4 digits
  plaidItemId    String
  plaidItem      PlaidItem @relation(fields: [plaidItemId], references: [id], onDelete: Cascade)
  createdAt      DateTime  @default(now())

  @@index([plaidItemId])
}
